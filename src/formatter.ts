import { DataFrame, PanelModel } from '@grafana/data';
import { defaultGrafanaOptions } from 'defaults';

/**
 * Represents a single-dimensional data point in time.
 */
type DataPoint = { [index: string]: number };

/**
 * The data structure for formatted time-series data.
 */
type FormattedData = { [index: number]: DataPoint };

/**
 * Format and clean up the panel data.
 * All series are expected to be time
 * series and have unique field names.
 * @param series The data object generated by the panel.
 * @returns A formatted object of panel data.
 * `{ timestamp : { field : value, ... }, ... }`
 */
export function format(series: DataFrame[]): FormattedData {
  const formatted: FormattedData = {};
  series.forEach((frame) => {
    frame.fields
      .find((field) => field.type === 'time')
      ?.values.forEach((t: number, i: number) => {
        frame.fields
          .filter((field) => field.type === 'number')
          .forEach((field) => {
            const name: string = field.config.displayNameFromDS || field.config.displayName || field.name;
            formatted[t] = formatted[t] || {};
            formatted[t][name] = field.values[i];
          });
      });
  });
  return formatted;
}

/**
 * Generate a list of unique field names from formatted data.
 * @param data The formatted data returned by `format(...)`
 * @returns A list of unique field names.
 */
export function getFieldList(data: FormattedData): string[] {
  let store: DataPoint = {};
  Object.values(data).forEach(point => store = { ...store, ...point });
  return Object.keys(store);
}

/**
 * Represents an override used for options migration.
 */
export interface Override<T> {
  /**
   * The target key on the cleaned options
   */
  readonly cleanKey: keyof T;
  /**
   * The source key on the original options
   */
  readonly dirtyKey: string;
  /**
   * The default value, if neither exists
   */
  readonly defaultVal: any;
}

/**
 * Set empty options of `dirty` to defaults.
 * @param dirty Any object with similar keys to `T`
 * @param defaultObj The default options for `T`
 * @returns A cleaned-up object.
 */
export function clean<T>(dirty: Partial<T>, defaultObj: T, overrides: Override<T>[] = []): T {
  const cleaned: T = JSON.parse(JSON.stringify(defaultObj));
  for (const key in cleaned) {
    cleaned[key] = dirty[key] ?? defaultObj[key];
  }
  for (const override of overrides) {
    cleaned[override.cleanKey] = cleaned[override.cleanKey] ?? dirty[override.dirtyKey as keyof T] ?? override.defaultVal;
  }
  return cleaned;
}

/**
 * Migrate an older set of panel options to a current model.
 */
export function migrate(panel: PanelModel) {
  const options = Object.assign({}, panel.options);
  console.log('Migrating: ' + JSON.stringify(options));
  // v4.x.x -> v5.0.0
  options['mollier'] = options['flipXY'] ?? defaultGrafanaOptions.mollier;
  return options;
}
